# Проектирование высоконагруженных приложений

## 1. Тема и целевая аудитория
YouTube — это видеохостинг для загрузки, хранения, просмотра и распространения видеороликов, а также один из крупнейших сервисов для обмена контентом и взаимодействия с аудиторией.

### Функционал MVP

- Загрузка видео  
- Просмотр видео  
- Поиск видео  
- Комментирование видео  
- Оценка видео  
- Подписка на автора видео (канал)  
- Получение списка рекомендаций  

### Целевая аудитория

По данным на июнь 2025 года платформа имеет 2,7 млрд пользователей в месяц (MAU) [[1]](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025).

Распределение целевой аудитории в зависимости от местоположения представлено в таблице:

| Страна    | MAU, млн                              |
| --------- | ------------------------------------- |
| Индия     | 491                                   |
| США       | 253                                   |
| Бразилия  | 144                                   |
| Индонезия | 143                                   |
| Мексика   | 83,6                                  |
| Япония    | 78,7                                  |
| Германия  | 65,5                                  |
| Вьетнам   | 62,3                                  |
| Филиппины | 57,7                                  |
| Турция    | 57,5                                  |

## 2. Расчет нагрузки

### Продуктовые метрики
| Метрика | Значение | Источник |
|---------|----------|----------|
|Месячная аудитория (MAU)|2,7 млрд|[[1]](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025)|
|Дневная аудитория (DAU)|400 млн|[[14]](https://www.statista.com/statistics/1252638/youtube-app-dau-worldwide/)|
|Среднее время использования в день|48,7 минут|[[3]](https://www.shopify.com/blog/social-media-marketing-statistics)|
|Средняя продолжительность видео|11,7 минут|[[6]](https://www.statista.com/statistics/1026923/youtube-video-category-average-length/)|
|Общее количество видео| 5,1 млрд|[[7]](https://seo.ai/blog/how-many-videos-are-on-youtube)|
|Общее количество каналов| 113,9 млн | [[1]](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025)|
|Количество просмотров страниц за день|9|[[1]](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025)
|Доля трафика с мобильных устройств|63%|[[1]](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025) [[2]](https://www.semrush.com/seo/26309235)|
|Объём новых видео за день|720 тысяч часов|[[1]](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025)|
|Общее время просмотров за день|1 млрд часов|[[1]](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025)|
|Суммарное количество поисков за день|3,5 млрд|[[1]](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025)|
|Среднее соотношение комментариев к просмотрам|0,5%|[[4]](https://pixelvalleystudio.com/pmf-articles/4-key-youtube-channel-statistics-and-how-to-calculate-them) [[5]](https://tubularlabs.com/blog/3-metrics-youtube-success/)|
|Среднее соотношение лайков к просмотрам|4%|[[4]](https://pixelvalleystudio.com/pmf-articles/4-key-youtube-channel-statistics-and-how-to-calculate-them) [[5]](https://tubularlabs.com/blog/3-metrics-youtube-success/)|
|Среднее соотношение подписок к просмотрам|0,3–0,5%|[[4]](https://pixelvalleystudio.com/pmf-articles/4-key-youtube-channel-statistics-and-how-to-calculate-them)|
|Среднее количество просмотров на видео|5 594|[[12]](https://tubularlabs.com/blog/average-youtube-views/)
|Количество новых каналов за день|60 000|[[13]](https://www.blogcadre.com/resources/how-many-youtube-channels-are-there/)

### Технические метрики

### Хранилище
#### Видео
В таблице выше представлено,что cредняя продолжительность видео: 11,7 минут.
Средний битрейт зависит от качества [[8]](https://support.google.com/youtube/answer/1722171?hl=en). 

| Разрешение | Битрейт видео (Mbps) |
|------------|----------------------|
| 2160p (4K) | 40                   |
| 1440p (2K) | 16                   |
| 1080p      | 8                    |
| 720p       | 5                    |
| 480p       | 2,5                  |
| 360p       | 1                    |

Учтем, что битрейт видео на выгрузку в среднем в 2 раза ниже, чем на загрузку.
На основании полученных данных произведем расчет размера видео разного качества в соответствии с формулой:

$$
\text{Размер видео (ГБ)} = \frac{\text{Битрейт (Mbps)} \times 10^6\ \text{бит/сек} \times \text{Длительность (сек)}}{8 \times 1024^3} 
$$

Самым популярным разрешением видео на сегодняшний день является 1080p [[9]](https://www.descript.com/blog/article/the-ultimate-guide-to-youtube-video-sizes). Будем производить расчет относительно него:

$$
\text{Размер видео} = \frac{8\ \text{(Mbps)} \times 10^6\ \text{бит/сек} \times 702\ \text{(сек)}}{2 \times 8 \times 1024^3} \approx 0,327\ \text{ГБ}
$$

$$
\text{Общий размер всех видео}  = \text{0,327 (ГБ)} \times \text{5,1 (млрд)} ≈ \text{1,67 ЭБ}
$$

Чтобы учесть наличие более низких и более высоких разрешений (360p–4K), усредняем:

- видео в 480p / 720p занимают меньше места (0,3–0,6 от базового 1080p),

- видео в 1440p / 2160p (4K) занимают больше (2–5 от базового).

В среднем итоговый объём будет в 1,2–1,3 раза больше базового расчёта.

$$
\text{Итоговый общий объём} ≈ \text{2 ЭБ}
$$

#### Миниатюры

На YouTube существует возможность добавлять превью (миниатюры) к видео размером до 2 МБ [[10]](https://support.google.com/youtube/answer/72431?hl=en&co=GENIE.Platform%3DAndroid#zippy=%2Cimage-size-resolution). По официальной информации 90% видео имеют превью [[11]]. Таким образом:

$$
\text{Общий размер всех превью} = 2 \text{ МБ} \times 5,1 \text{ млрд видео} \times 0,9
$$

#### Комментарии

Среднее соотношение комментариев к просмотрам - 0,3–0,5%. Примем среднее значение - 0,4%. Среднее количество просмотров - 5 594. Значит, в среднем 1 видео имеет:

$$
\text{Количество комментариев на одно видео} = 5 594 \times 0,004 = 22,376
$$

Примем средний размер комментария за 250 байт. Тогда:

$$
\text{Общий размер всех комментариев} = 22,376 \times 250\text{ Б} \times 5,1 \text{ млрд видео} ≈ \text{25,9 ТБ}
$$

#### Каналы

На сегодняшний день существует приблизительно 115 млн каналов. Допустим, что:

- Баннер канала 6 МБ
- Логотип канала 1 МБ

Тогда:

$$
\text{Общий объем данных каналов} = 7\text{ МБ} \times 115 \text{ млн} ≈ \text{0,75 ПБ}
$$

Полученные результаты представим в сводной таблице:

#### Сводная таблица объёмов хранилища YouTube

| Тип данных | Количество | Средний размер | Общий объём | Общий объём (ПБ) |
|------------|------------|----------------|-------------|-----------------------|
| Видео (усреднённо, базовое 1080p + коррекция на другие разрешения) | 5,1 млрд | 0,327 ГБ | ~2 ЭБ | ~2048 ПБ |
| Превью (миниатюры, 90% видео, до 2 МБ) | 5,1 млрд | 2 МБ × 0,9 | ~8,5 ПБ | ~8,5 ПБ |
| Комментарии (среднее количество на видео 22, размер 250 Б) | 114 млрд | 250 Б | ~25,9 ТиБ | ~0,025 ПБ |
| Каналы (баннер + логотип) | 115 млн | 7 МБ | ~0,75 ПБ | ~0,75 ПБ |

### Прирост данных в сутки

#### Видео
Объём новых видео за день	720 тысяч часов	[[1]](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025). Значит для 1080p:

$$
\text{Общее количество видео за сутки} = \frac{720\,000\ \text{часов} \times 60}{11,7 \text{минут}} ≈ 3,7 \text{ млн}
$$

$$
\text{Общий размер всех видео за сутки} = 3,7 \text{ млн} \times \text{0,327 (ГБ)} \times 1,3 ≈ 1,5 \text{ ПБ}
$$


#### Превью 

$$
\text{Общее количество превью за сутки} = 3,7 \text{ млн} \times 0,9 ≈ 3,3 \text{ млн}
$$

$$
\text{Общий размер всех превью за сутки} =
\frac{2\ \text{МБ} \times (720\,000 \times 60\ \text{минут})  \times 0,9 }{11,7\ \text{минут/видео}}
\approx 6,34\ \text{ТБ}
$$

#### Комментарии

$$
\text{Общее количество всех комментариев за сутки} = 0,004 \times \frac{1 \text{ млрд часов} \times 60\ \text{минут}}{11,7\ \text{минут}} ≈ \text{20,5 млн}
$$

$$
\text{Общий размер всех комментариев за сутки} = \text{20,5 млн} \times 250\text{ Б}  ≈ \text{4,78 ГБ}
$$

#### Каналы 

За день появляется приблизительно 70 000 новых каналов:

$$
\text{Общий объем данных каналов за сутки} = 7\text{ МБ} \times 70 000 ≈ \text{0,47 ТБ}
$$

#### Сводная таблица суточного прироста данных

| Тип данных | Количество за сутки | Средний размер | Общий объём за сутки | Общий объём за сутки (ПБ) |
|------------|-------------------|----------------|--------------------|---------------------------|
| Видео (усреднённо, 1080p + коррекция) | 3,7 млн | 0,327 ГБ × 1,3 коррекция | ~1,5 ПБ | 1,5 |
| Превью (миниатюры, 90% видео) | 3,3 млн | 2 МБ | ~6,34 ТБ | 0,00634 |
| Комментарии (среднее 22 комм./видео, 250 Б) | 20,5 млн | 250 Б | ~4,78 ГБ | 0,00000475 |
| Каналы (баннер + логотип) | 70 000 | 7 МБ | ~0,47 ТБ | 0,00047 |


### Средний размер хранилища на пользователя

| Тип данных  | Среднее количество на пользователя | Средний размер на пользователя (ГБ) |
| ----------- | ---------------------------------- | ------------------------------ |
| Видео       | 1,89                               | 0,8                            |
| Превью      | 1,7                                | 0,0033                         |
| Комментарии | 42,2                               | 0,00001                        |
| Каналы      | 0,043                              | 0,0003                         |

### RPS по типам запросов

**Допущения для расчёта:**

1. **DAU**: 400 млн пользователей.
2. **Период усреднения:** 24 часа (86 400 секунд).
3. **Пиковая нагрузка:** активность концентрируется в несколько часов, поэтому пиковый RPS считается с коэффициентом 2,5× среднего RPS.
4. *Среднее количество действий на пользователя в день (если явно не указано, берём оценки на основе продуктовых метрик):*

   * **Загрузка видео:** общее количество новых видео в сутки (3,7 млн) делим на DAU → 0,0093 загрузки/пользователь/день.
   * **Поиск видео:** общее количество поисковых запросов в день (3,5 млрд) делим на DAU → 8,75 поисков/пользователь/день.
   * **Комментирование видео:** 0,4% от просмотров → 9 × 0,004 ≈ 0,036 комментариев/пользователь/день.
   * **Оценка видео (лайки/дизлайки):** 4% от просмотров → 9 × 0,04 ≈ 0,36 лайков/пользователь/день.
   * **Подписка на канал:** 0,4% от просмотров → 9 × 0,004 ≈ 0,036 подписок/пользователь/день.
   * **Получение списка рекомендаций:** предполагаем, что рекомендации показываются при каждом просмотре → 9 рекомендаций/пользователь/день.
5. **Все расчёты округлены до целых или одного знака после запятой для удобства планирования ресурсов.**

На основании этих допущений рассчитывается **средний и пиковый RPS**:

| Тип запроса                   | Количество запросов в день на пользователя | Средний RPS | Пиковый RPS |
| ----------------------------- | ------------------------------------------ | ----------- | ----------- |
| Загрузка видео                | 0,0093                                     | 43          | 108         |
| Просмотр видео                | 9                                          | 41 667      | 104 167     |
| Поиск видео                   | 8,75                                       | 40 509      | 101 273     |
| Комментирование видео         | 0,036                                      | 167         | 417         |
| Оценка видео (лайк/дизлайк)   | 0,36                                       | 1 667       | 4 167       |
| Подписка на канал             | 0,036                                      | 167         | 417         |
| Получение списка рекомендаций | 9                                          | 41 667      | 104 167     |

### Сетевой трафик

| Тип запроса                   | Средний RPS | Пиковый RPS | Размер одного запроса | Средний трафик (Гбит/с) | Пиковый трафик (Гбит/с) | Суточный трафик (ГБ/сутки) |
| ----------------------------- | ----------- | ----------- | --------------------- | ----------------------- | ----------------------- | -------------------------- |
| Загрузка видео                | 43          | 108         | 0,685 ГБ              | 236                     | 592                     | 2 540 000                  |
| Просмотр видео                | 41 667      | 104 167     | 0,425 ГБ              | 141 669                 | 354 562                 | 1 530 000 000              |
| Поиск видео                   | 40 509      | 101 273     | 50 КБ                 | 16,2                    | 40,5                    | 174 000                    |
| Комментирование видео         | 167         | 417         | 1 КБ                  | 0,00133                 | 0,00333                 | 14,4                       |
| Оценка видео (лайк/дизлайк)   | 1 667       | 4 167       | 0,5 КБ                | 0,0067                  | 0,0167                  | 71,9                       |
| Подписка на канал             | 167         | 417         | 0,5 КБ                | 0,00067                 | 0,00167                 | 7,2                        |
| Получение списка рекомендаций | 41 667      | 104 167     | 50 КБ                 | 16,7                    | 41,7                    | 174 000                    |

## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам
Для распределения нагрузки и масштабирования имеет смысл разделять сервис по функциональным доменам:

1. **Видео-серверы (Video Delivery)**
   * Отвечают за хранение и потоковую передачу видео и аудио контента.
   * Высокий сетевой трафик, особенно для популярных видео и пиковых часов.

2. **Upload**
   * Обрабатывают загрузку новых видео от пользователей.
   * Требуется высокая пропускная способность на запись данных.
   * Изоляция от delivery позволяет не мешать потоковому просмотру и не перегружать CDN.

3. **CDN и статика**
   * Миниатюры, баннеры, JS/CSS для фронтенда.
   * Использование отдельного поддомена позволяет кэшировать контент на CDN и разгружать основные сервера.
  
4. **Поиск и рекомендации**
   * Отдельный сервис для полнотекстового поиска, выдачи результатов и персонализированных рекомендаций.
   * Использует специализированные базы данных и движки (Elasticsearch, Vector DB для рекомендаций).
  
5. **Комментарии**
   * Высокая доля write-операций: новые сообщения, лайки, ответы, ветвления обсуждений.
   * Интенсивная конкуренция за свежие данные.


### Обоснование расположения датацентров по функциональным доменам

1. **Видео-серверы**

   * Размещаются в крупных пользовательских кластерах (США, Европа, Азия).
   * Локальное хранение популярных видео снижает задержки и экономит глобальный трафик.
   * Используется **региональное кэширование**: видео, популярное в Испании, не загружается в кэш Алжира, если там нет аудитории.
   * Это сокращает избыточные расходы на хранение и межрегиональную синхронизацию.

2. **Upload**

   * Региональные точки приёма загрузки (США, Европа, Азия).
   * Пользователь заливает видео «ближайшему» серверу → быстро и без перегрузки глобальных каналов.
   * Репликация выполняется только в регионы, где есть потенциальный спрос (на основе прогноза и алгоритмов рекомендаций).

3. **CDN и статика**

   * Распределяются максимально широко по edge-локациям.
   * Миниатюры, баннеры, JS/CSS кэшируются ближе к пользователям.
   * Применяется селективное региональное кэширование: статический контент, востребованный только в определённой стране, не хранится глобально.

4. **Поиск и рекомендации (Search/Recommendations)**

   * Несколько крупных хабов (США, Европа, Азия).
   * Для оптимизации используются локальные индексы популярного контента (региональные тренды), а «глобальный» поиск доступен через центральные узлы.
   * Это снижает нагрузку на глобальные каналы при запросах о локальном контенте (например, пользователю в Японии нет смысла грузить европейские индексы).

5. **Комментарии (Comments)**

   * Централизованный сервис в ключевом узле.
   * Все операции (создание, лайки, ответы) происходят в одном месте, что упрощает консистентность и снижает межрегиональный трафик.
   * Для ускорения чтения часто используется глобальный кэш (например, CDN или региональные Redis-реплики)..

<img width="8639" height="3431" alt="image" src="https://github.com/user-attachments/assets/5b419a90-7516-44cd-a435-686993ea3877" />

| Регион / Страна             | Город(а) ДЦ    | Функциональные домены                  | Обоснование                                                                                |
| --------------------------- | -------------- | -------------------------------------- | ------------------------------------------------------------------------------------------ |
| **Индия**                   | Мумбаи         | Video Delivery, Upload, CDN            | Крупная аудитория, запад страны; региональное кэширование популярных видео и статики.      |
|                             | Нью-Дели       | Video Delivery, Search/Recommendations | Север Индии, крупный узел для поиска и рекомендаций; Upload перенесён на Мумбаи.           |
|                             | Калькутта      | Video Delivery, CDN                    | Восток страны; локальное кэширование и доставка видео.                                     |
|                             | Бангалор       | Video Delivery                         | Южная зона; Upload перенесён на Мумбаи, поддержка пиковых delivery.                        |
| **США**                     | Сиэтл          | Video Delivery, Upload                 | Западное побережье, поддержка загрузок и доставки.                                         |
|                             | Лос-Анджелес   | Video Delivery, CDN                    | Кэш популярных видео и фронтенд статика.                                                   |
|                             | Чикаго         | Video Delivery, Search/Recommendations | Центральная зона, индексы поиска и рекомендаций для США.                                   |
|                             | Нью-Йорк       | Video Delivery                         | Восточное побережье, доставка видео.                                                       |
| **Бразилия**                | Сан-Паулу      | Video Delivery, Upload                 | Основной рынок Латинской Америки; delivery и загрузка.                                     |
|                             | Рио-де-Жанейро | Video Delivery, CDN                    | Локальное кэширование популярных видео и статики для южного региона.                       |
| **Индонезия**               | Джакарта       | Video Delivery, Upload, CDN            | Основной центр, региональное кэширование и доставка видео.                                 |
| **Япония**                  | Токио          | Video Delivery, Search/Recommendations | Поиск и рекомендации с локальными трендами; доставка видео.                                |
| **Германия**                | Франкфурт      | Video Delivery, Upload, CDN, Comments  | Основной хаб для Европы, централизованные комментарии; Upload в Европе сосредоточен здесь. |
|                             | Мюнхен         | Video Delivery, Search/Recommendations | Центральная Европа, поиск и рекомендации, локальное кэширование.                           |
| **Вьетнам**                 | Ханой          | Video Delivery, Upload                 | Север страны, локальная доставка и загрузка.                                               |
|                             | Хошимин        | Video Delivery, CDN                    | Юг страны, локальное кэширование популярных видео.                                         |
| **Филиппины**               | Манила         | Video Delivery, Upload                 | Локальная доставка и загрузка для островов.                                                |
|                             | Себу           | Video Delivery, CDN                    | Кэширование популярных видео и статики.                                                    |
| **Турция**                  | Стамбул        | Video Delivery, Search/Recommendations | Европейская часть, рекомендации и поиск.                                                   |
|                             | Анкара         | Video Delivery, CDN                    | Турецкий хаб для доставки видео и статики.                                                 |
| **Африка**                  | Йоханнесбург   | Video Delivery, Upload                 | Южная Африка, доставка видео и локальная загрузка.                                         |
|                             | Найроби        | Video Delivery, CDN                    | Восточная Африка, локальное кэширование популярных видео.                                  |
|                             | Алжир          | Video Delivery, Search/Recommendations | Север Африки, поиск и рекомендации.                                                        |
| **Сингапур**                | Сингапур       | Video Delivery, Upload, CDN            | Региональный центр Юго-Восточной Азии, резервная доставка и кэш.                           |
| **ОАЭ (Ближний Восток)**    | Дубай          | Video Delivery, CDN                    | Центр для Ближнего Востока; кэш популярных видео, delivery.                                |
| **Австралия**               | Сидней         | Video Delivery, Upload, CDN            | Основной рынок региона, доставка, загрузка и локальное кэширование.                        |
| **Великобритания**          | Лондон         | Video Delivery, Search/Recommendations | Главный хаб Западной Европы, рекомендации и поиск.                                         |
| **Казахстан (Центр. Азия)** | Астана         | Video Delivery, Upload                 | Стратегическая точка для Центральной Азии и части России, локальная доставка и загрузка.   |
| **Колумбия**                | Богота         | Video Delivery, CDN                    | Север Южной Америки, локальное кэширование популярных видео.                               |
| **Аргентина**               | Буэнос-Айрес   | Video Delivery, CDN                    | Южная Южная Америка, локальное кэширование популярных видео.                               |
| **Финляндия**               | Хельсинки      | Video Delivery, Search/Recommendations | Север Европы и России, рекомендации и поиск.                                               |

<img width="1038" height="590" alt="image" src="https://github.com/user-attachments/assets/74a15d9a-0f05-4c93-ac30-0b1945216bee" />

### Расчет распределения запросов по ДЦ

Допущения:

   * Средний и пиковый RPS для типа запроса в стране распределяем пропорционально MAU региона и числу ДЦ с этим функционалом.
   * Если в стране несколько ДЦ с одинаковым функционалом (например, Upload), RPS делим поровну между ними.
   * Для запросов, которые выполняются только на отдельных ДЦ (например, Комментирование только во Франкфурте), RPS идёт только туда.

| Регион / Страна    | ДЦ (Город)       | Функциональный домен                     | Загрузка видео (средн/пик) | Просмотр видео (средн/пик) | Поиск видео (средн/пик) | Комментирование (средн/пик) | Лайки/дизлайки (средн/пик) | Подписка (средн/пик) | Рекомендации (средн/пик) |
|-------------------|-----------------|----------------------------------------|----------------------------|----------------------------|-------------------------|-----------------------------|----------------------------|---------------------|---------------------------|
| Индия             | Мумбаи          | Video Delivery, Upload, CDN             | 7,83/19,57                | 1894,29/4735,73           | -                       | -                           | -                          | -                   | -                         |
|                   | Нью-Дели        | Video Delivery, Search/Recommendations | -                          | 1894,29/4735,73           | 7366,68/18416,71       | -                           | -                          | -    | 7577,16/18942,90          |
|                   | Калькутта       | Video Delivery, CDN                     | -                          | 1894,29/4735,73           | -                       | -                           | -                          | -                   | -                         |
|                   | Бангалор        | Video Delivery                          | -                          | 1894,29/4735,73           | -                       | -                           | -                          | -                   | 7577,16/18942,90          |
| США               | Сиэтл           | Video Delivery, Upload                  | 4,03/10,09                | 976,08/2440,20            | -                       | -                           | -                          | -                   | -                         |
|                   | Лос-Анджелес    | Video Delivery, CDN                     | -                          | 976,08/2440,20            | -                       | -                           | -                          | -                   | -                         |
|                   | Чикаго          | Video Delivery, Search/Recommendations | -                          | 976,08/2440,20            | 3795,87/9489,67        | -                           | -                          | -    | 3904,32/9760,80           |
|                   | Нью-Йорк        | Video Delivery                          | -                          | 976,08/2440,20            | -                       | -                           | -                          | -                   | -                         |
| Бразилия          | Сан-Паулу       | Video Delivery, Upload                  | 2,30/5,74                  | 1111,11/2777,78           | -                       | -                           | -                          | -                   | -                         |
|                   | Рио-де-Жанейро  | Video Delivery, CDN                     | -                          | 1111,11/2777,78           | -                       | -                           | -                          | -                   | -                         |
|                   |                 |                                        | -                          | 2222,22/5555,56           | -                       | -                           | -                          | -                   | -                         |
| Индонезия         | Джакарта        | Video Delivery, Upload, CDN             | 2,28/5,70                  | 2206,79/5516,98           | -                       | -                           | -                          | -                   | -                         |
| Япония            | Токио           | Video Delivery, Search/Recommendations | -                          | 1214,51/3036,27           | 1180,77/2951,92        | -                           | -                          | -                   | 1214,51/3036,27          |
| Германия          | Франкфурт       | Video Delivery, Upload, CDN, Comments  | 1,04/2,61                  | 505,40/1263,50            | -                       | 166,67/416,67              | 1666,67/4166,67           | 167/417                   | -                         |
|                   | Мюнхен          | Video Delivery, Search/Recommendations | -                          | 505,40/1263,50            | 982,72/2456,81         | -                           | -                          | -                   | 1010,80/2527,01           |
| Вьетнам           | Ханой           | Video Delivery, Upload                  | 0,99/2,48                  | 480,71/1201,77            | -                       | -                           | -                          | -                   | -                         |
|                   | Хошимин         | Video Delivery, CDN                     | -                          | 480,71/1201,77            | -                       | -                           | -                          | -                   | -                         |
|                   |                 |                                        | -                          | 961,42/2403,55            | -                       | -                           | -                          | -                   | -                         |
| Филиппины         | Манила          | Video Delivery, Upload                  | 0,92/2,30                  | 445,22/1113,04            | -                       | -                           | -                          | -                   | -                         |
|                   | Себу            | Video Delivery, CDN                     | -                          | 445,22/1113,04            | -                       | -                           | -                          | -                   | 887,35/2218,36            |
| Турция            | Стамбул         | Video Delivery, Search/Recommendations | 0,92/2,29                  | 443,67/1109,18            | 862,70/2156,74         | -                           | -                          | -                   | -                         |
|                   | Анкара          | Video Delivery, CDN                     | -                          | 443,67/1109,18            | -                       | -                           | -                          | -                   | 887,35/2218,36            |
| Африка            | Йоханнесбург    | Video Delivery, Upload                  | 0,85/2,13                  | 400,00/1000,00            | -                       | -             | -             |-        | 500,00/1250,00            |
|                   | Найроби         | Video Delivery, CDN                     | -                          | 400,00/1000,00            | -                       | -                           | -                          | -                   | -                         |
|                   | Алжир           | Video Delivery, Search/Recommendations | -                          | 400,00/1000,00            | 500,00/1250,00         | -                           | -                          | -                   | 500,00/1250,00            |
### DNS балансировка

**Схема работы:**

* Используется GeoDNS для глобального распределения пользователей.
* Каждому региону или стране присваивается набор Anycast-адресов, анонсируемых ближайшими датацентрами. DNS возвращает пользователю один из этих адресов в зависимости от геолокации.

**Влияние на продуктовые метрики:**

* **Региональная сегментация нагрузки:** позволяет разделять глобальную аудиторию по зонам, облегчая управление ресурсами.

DNS определяет региональный ДЦ, задавая «глобальные границы» маршрутизации. Она не выбирает конкретный сервер, а определяет регион обслуживания.

### Anycast балансировка

**Схема работы:**

* Один и тот же **IP адрес анонсируется из нескольких ДЦ**.
* Сетевые маршрутизаторы автоматически выбирают ближайший или наименее загруженный путь.
* При падении одного ДЦ трафик автоматически перенаправляется на другие узлы с тем же Anycast IP.

**Влияние на продуктовые метрики:**

* **Быстрое переключение при сбоях:** пользовательский IP остаётся неизменным.
* **Равномерное распределение нагрузки:** снижает пиковые задержки на потоковую передачу видео.
* **Повышение отказоустойчивости:** критические сервисы продолжают работать без заметного влияния на клиента.

**Связь с DNS:** 
Внутри региона, выбранного через DNS, Anycast распределяет трафик между локальными узлами или ДЦ, обеспечивая высокую доступность и балансировку нагрузки. Он действует внутри региона, выбранного DNS, и распределяет нагрузку между несколькими датацентрами.

### Механизм регулировки трафика между ДЦ

**Ограничения Anycast:**

* В классической схеме Anycast балансировка происходит на уровне маршрутизаторов (BGP).
* Решения принимаются по сетевым метрикам, но не учитывают реальную нагрузку ДЦ (RPS, CPU, состояние кэша).
* Регулировка возможна только косвенно — например, «удлиняя» путь или изменяя приоритет, что является грубым инструментом и не позволяет гибко балансировать.

**Схема работы с GNS/GSLB:**

* Используется Global Name Service (GNS) для динамического управления трафиком.
* Система учитывает текущие метрики нагрузки: RPS, CPU/IO, доступность CDN-кэша, сетевые задержки.
* DNS-ответы формируются не только по географии, но и с учётом состояния ДЦ.
* При локальном пике или сбое трафик может быть оперативно перенаправлён в соседний ДЦ или резервный международный узел.
* Управление выполняется через интеграцию с системами мониторинга (Prometheus, Grafana, Observability) и SDN-контроллерами.

**Влияние на продуктовые метрики:**

* **Минимизация отказов при перегрузке**: трафик уходит с перегруженного узла раньше, чем пользователи почувствуют деградацию.
* **Стабильное качество видео и API**: регулировка нагрузки снижает задержки и исключает «узкие места».
* **Оптимизация расходов**: предпочтение локального трафика внутри региона (дешевле, чем международный).


**Связь с DNS и Anycast:**

DNS задаёт глобальный регион .Anycast распределяет трафик между узлами внутри региона. GNS/GSLB динамически перераспределяет нагрузку между датацентрами по метрикам.
Вместе эти механизмы обеспечивают оптимальное распределение нагрузки и высокую отказоустойчивость как на глобальном, так и на региональном уровнях.

## 4. Локальная балансировка нагрузки

### Уровни балансировки

  **1. Балансировка на уровне L3/L4**
  
  Для распределения трафика внутри датацентра выберем схему **Virtual Server via Direct Routing (DR)**.
  
  #### Аргументация выбора DR:
  
  * Высокая производительность — балансировщик не обрабатывает обратный трафик, что устраняет проблему «бутылочного горлышка» при больших потоках.
  * Минимальная нагрузка на CPU балансировщика — выполняется только изменение MAC-адреса пакета, без пересчета контрольных сумм и NAT-операций.
  * Простая интеграция с аппаратными и программными решениями.
  * Подходит для сценариев, где трафик идет в основном в одном направлении (например, доставка больших видеофайлов пользователям).
  * Хотя L3/L4 балансировщик работает на уровне TCP/IP и не анализирует HTTPS-запросы, он может направлять трафик на разные пулы L7 или       Web LB по признакам пакета:
    - VIP/IP-адрес и порт
    - Каждый сервис (например, Upload, Comments, Search) имеет отдельный виртуальный IP или порт на L3/L4 балансировщике.
    - На основе IP/порта L3/L4 определяет, в какой пул серверов направить поток, не загружая себя разбором HTTP.
    
  #### Ограничения:
  
  Хотя Direct Routing требует, чтобы реальные серверы находились в одной L2-сети, это ограничение можно обойти с помощью GRE-туннелей. Балансировщик устанавливает туннель к каждому серверу, находящемуся в другой подсети. Пакеты инкапсулируются в GRE и доставляются на сервер, где туннель снимается, а сервер отвечает напрямую клиенту. Таким образом сохраняется высокая производительность DR, при этом серверы могут быть распределены по разным физическим сетям внутри датацентра.
  
  #### Резервирование
  
  Для обеспечения отказоустойчивости используется схема **N+1**.
  Если для обработки пикового трафика требуется `N` активных балансировщиков, то общее количество устройств рассчитывается как N + 1.
  Это гарантирует, что при выходе из строя любого одного балансировщика оставшиеся смогут перераспределить нагрузку без деградации качества обслуживания.
  
  #### Мониторинг и автоматическое переключение
  
  Используется **keepalived** с VRRP/CARP для резервирования и проверки доступности серверов.  
  <br>
  <br>
  **2. Балансировка на уровне L7**
  
  L7-балансировка применяется не во всех датацентрах, а только там, где обрабатываются сервисы прикладного уровня: загрузка видео (Upload), комментарии (Comments), поиск и рекомендации (Search/Recommendations), статика и CDN.
  
  #### Принципы применения L7-балансировки
  
  * **Контент-зависимая маршрутизация** — балансировщик анализирует HTTP-запрос и направляет его в соответствующий пул (например, `POST /upload` → Upload Cluster, `GET /watch?v=…` → Delivery Cluster).
  * **Sticky sessions** (cookie или IP) для сервисов, где нужна консистентность состояния (Upload, Comments).
  * **Контроль SLA**: разные пулы серверов для Comments vs Search/Recommendations позволяют разграничить ресурсы и поддерживать стабильное время отклика для критичных сервисов.

  #### Failover и резервирование:
  
  Для L7 балансировки выберем **схему N+1**:
  
  Аргументация:
  
  * L7-балансировщик обычно более «тяжёлый» по ресурсам (анализ HTTP-запросов, cookie, URL), но один резервный узел способен покрыть выход из строя любого из N активных.
  * Формула **N+1** проще, достаточно надёжна и не приводит к избыточному количеству серверов, что важно для дорогостоящих L7-устройств.
  * Она применяется как для балансировщиков, так и для серверов приложений, обеспечивая простое и предсказуемое резервирование.
  
  
  #### Мониторинг и failover
  
  * Проверка доступности сервисов выполняется через **HTTP health-check** (HEAD/GET `/ping`, `/health`).
  * Автоматическое переключение на резервные узлы — через keepalived/VRRP или встроенные механизмы HAProxy/Nginx.
  
  L7-балансировка применяется выборочно:
  
  * **Delivery-only ДЦ** (например, Бангалор, Нью-Йорк) обходятся L3/L4 балансировкой (DR).
  * **Функциональные ДЦ** (Франкфурт, Сиэтл, Мумбаи, Токио) получают расширенные L7-балансировщики для распределения трафика по сервисам.
  
Таким образом, L3/L4 балансировка  обеспечивает высокую производительность и обработку потокового трафика во всех датацентрах, минимизируя нагрузку на балансировщики. L7 балансировка используется выборочно, и в этой архитектуре L3/L4 и L7 балансировка работают в связке, дополняя друг друга. Сначала L3/L4 балансировщик принимает весь входящий трафик на уровне TCP/IP и распределяет пакеты на L7-пулы, обеспечивая высокую производительность для потоковых сервисов, таких как Video Delivery, без лишней нагрузки на процессор. Затем для сервисов, где нужна логика приложений, трафик направляется на L7 балансировщики, которые анализируют HTTP-запросы, реализуют sticky sessions и маршрутизируют запросы к нужным приложениями. Если L7 отсутствует, L3/L4 балансировщик направляет трафик на пул веб-балансировщиков (Web LB) напрямую.
<br>
<br>
  **3. Балансировка на уровне веб-серверов**
  
 * Балансировка на уровне веб-серверов внутри каждого функционального домена распределяет запросы между несколькими серверами одного сервиса.
 * Несколько веб-серверов обеспечивают отказоустойчивость — при падении одного остальные продолжают работу.
 * Настройка таймаута на основе квантилей:

   * Если запрос от сервера превышает 95-й процентиль времени отклика, соединение закрывается и перенаправляется на менее загруженный сервер.
 * Кеширование сессий снижает нагрузку на SSL Termination:

   * После обмена ключей (RSA handshake) дальнейшие запросы проходят через HTTP без повторного дорогостоящего обмена ключами.

То есть, хотя функциональные домены уже определены, веб-серверный балансировщик нужен для отказоустойчивости и равномерного распределения нагрузки внутри конкретного сервиса, особенно если у сервиса несколько экземпляров.  

<img width="616" height="471" alt="local_balancing" src="https://github.com/user-attachments/assets/c125f40e-f839-40e5-b03d-890d27bed23e" />

### Расчёт количества балансировщиков

#### Ограничение 1: SSL Termination

* Пусть один балансировщик может обрабатывать `C_ssl` соединений в секунду при SSL Termination без деградации производительности.
* Пиковая нагрузка по HTTPS (RPS с учётом всех сервисов, которые обрабатывают L7) обозначается `R_peak`.

Тогда минимальное количество балансировщиков для SSL:

$$
N_{ssl} = \lceil \frac{R_{peak}}{C_{ssl}} \rceil
$$

### Ограничение 2: Пропускная способность сети

Сетевая подсистема балансировщика имеет максимальную пропускную способность `B_max` (Гбит/с). Пиковый трафик, который должен пройти через балансировщик, обозначим `T_peak`.

Количество балансировщиков по сетевой пропускной способности:

$$
N_{net} = \lceil \frac{T_{peak}}{B_{max}} \rceil
$$

### Итоговый расчёт

L3/L4 – пропускает весь трафик без дешифровки. Берем пиковый трафик, делим на пропускную способность одного балансировщика и добавляем резерв +1 (N+1).

L7 – выполняет SSL Termination, поэтому учитываем и $$N_{ssl}$$ и $$N_{net}$$. Из них выбираем наибольшее значение и к нему добавляем резерв.

**Допущения**:

* L3/L4: 1 устройство = 100 Гбит/с
* L7: 1 устройство = 5 000 RPS / 20 Гбит/с (SSL дешифровка)

| ДЦ (Город)     | Функциональный домен                   | Суммарный RPS пик | Суммарный трафик пик (Гбит/с) | N L3/L4 | N L7 |
| -------------- | -------------------------------------- | ----------------- | ----------------------------- | ------- | ---- |
| Мумбаи         | Video Delivery, Upload, CDN            | 4755,30           | 18,65                         | 2       | 2    |
| Нью-Дели       | Video Delivery, Search/Recommendations | 42095,34          | 32,75                         | 2       | 10   |
| Калькутта      | Video Delivery, CDN                    | 4735,73           | 18,50                         | 2       | 2    |
| Бангалор       | Video Delivery                         | 4735,73           | 18,50                         | 2       | -    |
| Сиэтл          | Video Delivery, Upload                 | 2450,29           | 9,61                          | 2       | 2    |
| Лос-Анджелес   | Video Delivery, CDN                    | 2440,20           | 9,53                          | 2       | 2    |
| Чикаго         | Video Delivery, Search/Recommendations | 21690,67          | 16,88                         | 2       | 6    |
| Нью-Йорк       | Video Delivery                         | 9760,80           | 9,53                          | 2       | -    |
| Сан-Паулу      | Video Delivery, Upload                 | 2783,52           | 10,90                         | 2       | 2    |
| Рио-де-Жанейро | Video Delivery, CDN                    | 2777,78           | 10,85                         | 2       | 2    |
| Джакарта       | Video Delivery, Upload, CDN            | 5522,68           | 21,60                         | 2       | 3    |
| Токио          | Video Delivery, Search/Recommendations | 9024,46           | 14,14                         | 2       | 3    |
| Франкфурт      | Video Delivery, Upload, CDN, Comments  | 5849,45           | 4,98                          | 2       | 3    |
| Мюнхен         | Video Delivery, Search/Recommendations | 5054,01           | 10,84                         | 2       | 3    |
| Ханой          | Video Delivery, Upload                 | 1204,26           | 4,71                          | 2       | 2    |
| Хошимин        | Video Delivery, CDN                    | 1201,77           | 4,69                          | 2       | 2    |
| Манила         | Video Delivery, Upload                 | 1115,34           | 4,37                          | 2       | 2    |
| Себу           | Video Delivery, CDN                    | 1113,04           | 4,35                          | 2       | 2    |
| Стамбул        | Video Delivery, Search/Recommendations | 3268,22           | 5,17                          | 2       | 2    |
| Анкара         | Video Delivery, CDN                    | 1109,18           | 4,33                          | 2       | 2    |

## 5. Логическая схема БД
<img width="735" height="718" alt="image" src="https://github.com/user-attachments/assets/504bd50f-e9b5-408f-beb2-a8ac10581ea3" />


| Таблица          | Поля (оценочный размер)                                                                                                                                       | Типы данных                          | Описание               | Примерный размер / запись | Общее кол-во записей    | Суточный прирост записей | RPS чтение (среднее / пиковое) | RPS запись (среднее / пиковое) | Консистентность | Кэши                                                                                     |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------ | ---------------------- | ------------------------- | ----------------------- | ----------------------- | ------------------------------ | ------------------------------ | --------------- | --------------------------------------------------------------------------------------------------------------------- |
| `user`           | `id(16 B), name(~50 B), email(~50 B), password_hash(32 B), avatar_url(~100 B), banner_url(~100 B), country(2 B), gender(1 B), created_at(8 B), birthday(3 B)` | UUID, VARCHAR, DATETIME, DATE        | Пользователи платформы | ~362 B                    | ~115 млн                | ~70 тыс                 | 82 176 / 205 440               | —                              | Сильная         | Кэш профилей авторов                                                                                                  |
| `video`          | `id(16 B), title(~100 B), author_id(16 B), description(~1 KB), created_at(8 B), updated_at(8 B), thumbnail_url(~200 B), duration(4 B)`                        | UUID, VARCHAR, TEXT, DATETIME, FLOAT | Видеоконтент           | ~1,36 KB                  | ~5,1 млрд               | ~3,7 млн                | 82 176 / 205 440               | 43 / 108                       | Eventual        | Кэш метаданных видео                                                                                                  |
| `chunk`          | `id(16 B), video_id(16 B), quality(~10 B), chunk_index(4 B), url(~200 B), size(4 B), duration(4 B)`                                                           | UUID, INTEGER, VARCHAR, FLOAT        | Файловые чанки видео   | ~254 B                    | ~5,1 трлн               | ~3,7 млрд               | 41 667 / 104 167               | 43 / 108                       | Eventual        | Чанки кэшируются в CDN                                                                                                |
| `comment`        | `id(16 B), text(~1 KB), video_id(16 B), author_id(16 B), created_at(8 B), updated_at(8 B), parental_comment_id(16 B)`                                         | UUID, TEXT, DATETIME                 | Комментарии к видео    | ~1,08 KB                  | ~142 млрд               | ~20,5 млн               | 41 667 / 104 167               | 167 / 417                      | Сильная         | Топ-комментарии кэшируются в CDN                                                                                      |
| `video_reaction` | `id(16 B), author_id(16 B), video_id(16 B), is_upvote(1 B), created_at(8 B)`                                                                                  | UUID, BOOLEAN, DATETIME              | Лайки/дизлайки видео   | ~57 B                     | ~1,1 трлн               | ~827,9 млн              | 41 667 / 104 167               | 1 667 / 4 167                  | Сильная         | Счётчики лайков кэшируются                                                                                            |
| `view`           | `id(16 B), user_id(16 B), video_id(16 B), watched_at(8 B), watch_duration (4 B)                                                                               | UUID, DATETIME, FLOAT                | Просмотры видео        | ~60 B                     | ~28,5 трлн              | ~20,1 млрд              | 82 176 / 205 440               | 41 667 / 104 167               | Eventual        | Просмотры агрегируются в in-memory счётчики и кэшируются |
| `subscription`   | `id(16 B), channel_id(16 B), subscriber_id(16 B), created_at(8 B)`                                                                                            | UUID, DATETIME                       | Подписки на каналы     | ~56 B                     | ~114 млрд               | ~82,8 млн               | 41 667 / 104 167               | 167 / 417                      | Сильная         | Кэш списка подписчиков популярных каналов      |

## 6. Физическая схема БД
<img width="880" height="498" alt="image" src="https://github.com/user-attachments/assets/00610fd7-617e-44d4-85f4-b0cc00375827" />



| Таблица / Хранилище | СУБД / хранение   | Типы данных / поля                                                                                                                                                           | Индексы                                                               | Шардирование                                                                      | Денормализация / кэш                                                           | Клиентские библиотеки / интеграции | Балансировка / мультиплексирование   | Резервное копирование / репликация                | Реплики / количество нод       |
| ------------------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- | --------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ | ---------------------------------- | ------------------------------------ | ------------------------------------------------- | ------------------------------ |
| **user**            | **PostgreSQL**    | `id UUID, name VARCHAR, email VARCHAR, password_hash CHAR(32), avatar_key VARCHAR, banner_key VARCHAR, country CHAR(2), gender CHAR(1), created_at TIMESTAMP, birthday DATE` | PK(id), UNIQUE(email)                                                 | hash по id (PK), hash по email (UNIQUE)                                           | хранение числа подписчиков — дублирование (кэш из `user_counters`)             | `pgx`, `go-sqlx`                   | PgBouncer для соединений             | full backup daily + incremental 6 ч, master–slave | Master: 1, Read: 3–4           |
| **user_media**      | **S3**            | файлы аватаров и баннеров (`users/{uuid}/avatar.jpg`, `users/{uuid}/banner.png`)                                                                                             | —                                                                     | —                                                                                 | исходные файлы (нет денормализации)                                            | `minio-go`                         | S3 internal load balancing           | versioning + cross-region replication             | Multi-region (3 зоны)          |
| **user_counters**   | **PostgreSQL**    | `user_id UUID, subscribers_count INT, subscriptions_count INT, videos_count INT`                                                                                             | PK(user_id)                                                           | hash по user_id                                                                   | агрегат — суммирует данные из `subscription`, `video`                          | `pgx`                              | PgBouncer                            | full backup + logical replication                 | Master: 1, Read: 2–3           |
| **video**           | **PostgreSQL**    | `id UUID, title VARCHAR, author_id UUID, description TEXT, created_at TIMESTAMP, updated_at TIMESTAMP, thumbnail_key VARCHAR, duration FLOAT`                                | PK(id), INDEX(title), INDEX(author_id)                                | hash по id (PK), hash по author_id (INDEX author_id), hash по title (INDEX title) | лайки и просмотры — дублирование из `video_counters`; кэш имени/аватара автора | `pgx`                              | HAProxy (master + replicas)          | full + incremental backup, репликация             | Master: 1, Read: 3             |
| **video_media**     | **S3**            | превью (thumbnail): `videos/{uuid}/thumbnail.jpg`                                                                                                                            | —                                                                     | —                                                                                 | исходные файлы (нет денормализации)                                            | `minio-go`                         | S3 replication across CDN edge nodes | cross-region replication                          | Multi-region                   |
| **video_counters**  | **PostgreSQL**    | `video_id UUID, views INT, likes INT, comments INT`                                                                                                                          | PK(video_id)                                                          | hash по video_id                                                                  | агрегат — суммирует данные из `view`, `video_reaction`, `comment`              | `pgx`                              | PgBouncer                            | backup + logical replication                      | Master: 1, Read: 2–3           |
| **video_search**    | **Elasticsearch** | `video_id, title, description, author_name, views`                                                                                                                           | fulltext index(title, description)                              | shard по video_id (для title/description), shard по author_name                   | дублирование данных из `video` — кэш для ускоренного поиска                    | `elastic/go-elasticsearch`         | Elastic load balancer                | snapshots + replication                           | ES nodes: 3                    |
| **chunk**           | **PostgreSQL**    | `id UUID, video_id UUID, quality VARCHAR, chunk_index INT, chunk_key VARCHAR, size INT, duration FLOAT`                                                                      | PK(id), INDEX(video_id, chunk_index)                                  | hash по id (PK), hash по video_id+chunk_index (INDEX)                             | исходные файлы (нет денормализации)                                            | `pgx`                              | connection pooler                    | full + incremental backup                         | Master: 1, Read: 2–3           |
| **chunk_storage**   | **S3**            | файлы чанков: `videos/{video_id}/chunks/{quality}/chunk_{index}.mp4`                                                                                                         | —                                                                     | —                                                                                 | исходные файлы (нет денормализации)                                            | `minio-go`                         | S3 replication + edge cache          | cross-region replication                          | Multi-region                   |
| **comment**         | **PostgreSQL**    | `id UUID, text TEXT, video_id UUID, author_id UUID, created_at TIMESTAMP, updated_at TIMESTAMP, parental_comment_id UUID`                                                    | PK(id), INDEX(video_id), INDEX(author_id), INDEX(parental_comment_id) | hash по id (PK), hash по video_id, hash по author_id, hash по parental_comment_id | топ-комментарии — кэш для быстрого вывода                                      | `pgx`, `go-sqlx`                   | Patroni failover                     | full + incremental backup                         | Master: 1, Read: 3–4           |
| **subscription**    | **PostgreSQL**    | `id UUID, channel_id UUID, subscriber_id UUID, created_at TIMESTAMP`                                                                                                         | PK(id), INDEX(channel_id, subscriber_id), INDEX(subscriber_id)        | hash по id (PK), hash по subscriber_id (INDEX), hash по channel_id+subscriber_id  | дублируется в `user_counters` для агрегата                                     | `pgx`, `go-sqlx`                   | PgBouncer connection pooling         | full backup + logical replication                 | Master: 1, Read: 2–3           |
| **view**            | **ClickHouse**    | `id UUID, user_id UUID, video_id UUID, watched_at TIMESTAMP, watch_duration FLOAT`                                                                                           | PK(id), INDEX(video_id, user_id), INDEX(user_id)                      | shard по id (PK), shard по video_id+user_id (INDEX), shard по user_id(INDEX)      | агрегат — аналитика просмотров пользователей                                   | `ClickHouse Go driver`             | ClickHouse cluster                   | replication via Zookeeper                         | Shards: 4, Replicas: 2         |
| **video_reaction**  | **ClickHouse**    | `id UUID, author_id UUID, video_id UUID, is_upvote BOOLEAN, created_at TIMESTAMP`                                                                                            | PK(id), INDEX(video_id, author_id), INDEX(author_id)                  | shard по id (PK), shard по video_id+author_id (INDEX), shard по author_id(INDEX)  | хранится как источник для агрегатов (`video_counters`)                         | `ClickHouse Go driver`             | shard+replica balancing              | replicated tables via Zookeeper                   | Shards: 4, Replicas: 2 (8 нод) |
| **user_vector**     | **PostgreSQL**  | `user_id UUID, vector FLOAT[], updated_at TIMESTAMP`  | PK(user_id)                           | hash по user_id                               | кэш векторов пользователей для быстрого расчёта рекомендаций | pgx, go-sqlx                       | PgBouncer connection pooling       | full backup + logical replication  | Master: 1, Read: 2–3     |
| **video_vector**    | **PostgreSQL**  | `video_id UUID, vector FLOAT[], updated_at TIMESTAMP` | PK(video_id), vector_index (pgvector) | hash по video_id + шарды по сегментам вектора | кэш векторов видео для быстрого расчёта рекомендаций         | pgx, go-sqlx                       | PgBouncer connection pooling       | full backup + logical replication  | Master: 1, Read: 2–3     |


## 7. Алгоритмы
| Алгоритм                                           | Область применения                  | Мотивация / назначение                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -------------------------------------------------- | ----------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Алгоритм сегментации видео**                     | Загрузка и потоковая передача видео | **Назначение:** уменьшение задержек при просмотре, оптимизация сетевого трафика и обеспечение масштабируемости.  <br> **Принцип работы:** <br>  1. Пользователь загружает видео на upload-сервер, ему присваивается UUID. <br> 2. Видео кодируется в несколько вариантов качества и сегментируется на чанки разных разрешений. Для каждого чанка формируется метаинформация: ссылка на хранилище, размер и длительность, качество <br> 3. Чанки распределяются по хранилищам и CDN с учётом региональной популярности. Сначала кэшируются первые чанки видео (для ускоренного старта воспроизведения). <br> 4. Клиентский плеер запрашивает первый чанк с ближайшего CDN-узла. Алгоритм адаптивного стриминга оценивает скорость соединения и выбирает качество следующих чанков. Если CDN не содержит нужный чанк, запрос перенаправляется на центральное хранилище, после чего чанк кэшируется на CDN.                                                                                                                             |
| **Алгоритм адаптивного стриминга**                 | Просмотр видео                      | **Назначение:** поддержка стабильного воспроизведения при разных скоростях соединения. <br> **Принцип работы:** <br> 1. Пользователь открывает видео → плеер загружает манифест, который содержит ссылки на все чанки разных качеств. Плеер делает первый запрос чанка, выбирая среднее качество по умолчанию. <br> 2. Плеер измеряет скорость текущей загрузки, время ответа сервера, уровень буфера. <br> 3. Алгоритм динамически выбирает качество на основании битрейта, который выдерживает текущая скорость соединения, прогноза скорости (учитываются скачки и тренды, чтобы не менять качество слишком часто), буферизации: если буфер почти пуст, выбирается более низкое качество для предотвращения пауз. Плейер запрашивает следующий чанк соответствующего качества с ближайшего CDN-узла. <br> 4. Алгоритм корректирует качество на лету: при улучшении соединения → повышается качество, при ухудшении → понижается. Переходы выполняются между чанками, чтобы пользователь не замечал скачков. |
| **Алгоритм персонализированных рекомендаций**      | Получение списка рекомендаций       |  **Назначение:** предоставление персонализированных рекомендаций пользователям с минимальной задержкой и высокой релевантностью. <br> Принцип работы: <br> 1. Предварительная фильтрация (candidate generation): перед тем как считать точные сходства, отбирается небольшая подвыборка кандидатов: по популярности, недавно добавленные; по автору и подпискам пользователя (например, ~30% кандидатов от авторов, на которых подписан юзер, остальные — от других авторов); эта подвыборка значительно сокращает количество видео для точного расчёта сходства. Смотрим подписки пользователя в таблице subscription → выбираем видео от этих авторов (video.author_id) за последние N дней. Берём популярные видео из таблицы video_counters. Добавляем новые видео (с недавним created_at). Объединяем эти источники → формируем подвыборку video_id, обычно ограниченную 500–1000 видео на пользователя Для каждого пользователя создаётся вектор интересов (user_vector), который формируется из видео, с которыми он взаимодействовал, для каждого видео — вектор признаков (video_vector). <br> 2. При взаимодействии пользователя с видео (просмотр, лайк, комментарий, подписка) система формирует событие с весом действия (например, просмотр = 1, лайк = 3, подписка = 5). Эти события добавляются в очередь на обработку для обновления вектора пользователя. <br> 3. Алгоритм обновления вектора пользователя: <br>   a) Извлекается текущий user_vector. <br>   b) Получается video_vector для взаимодействовавшего видео. <br>   c) Выполняется взвешенное объединение. <br>   d) Вектор сохраняется обратно в user_vector с обновлением updated_at. <br> 4. Для генерации рекомендаций: <br>   a) Из базы извлекается актуальный user_vector. <br>   b) Вычисляется сходство между user_vector и video_vector всех кандидатов (например, топ популярных или новых видео) c помощью косинусной близости. <br>   c) Отбираются топ-N видео с наибольшим сходством, дополнительно фильтруется уже просмотренное пользователем. <br> 5. Полученный список рекомендаций возвращается на фронтенд и может кэшироваться для повторных запросов, обновляясь через фиксированные интервалы или по событию значительных изменений в векторах пользователей. <br> 6. Обновление video_vector выполняется периодически при добавлении нового видео или массовом пересчёте признаков (например, на основе текста, категорий, тегов и метрик популярности). Это позволяет вектору видео отражать актуальные характеристики для качественного совпадения с интересами пользователей. |                                                                         |
| **Алгоритм поиска видео**                          | Полнотекстовый поиск по видео       | **Назначение:** находить видео по ключевым словам, тегам, названию или описанию, обеспечивая быстрый и релевантный результат. <br> **Принцип работы:** <br> 1. Индексируются метаданные видео: название, описание, автор, категория. Создаётся полнотекстовый индекс Elasticsearch (video_search). <br> 2. Пользователь вводит поисковый запрос на фронтенде. <br> 3. Запрос обрабатывается сервером поиска: токенизация, приведение к нижнему регистру, удаление стоп-слов, стемминг. <br> 4. В индексе выполняется поиск по совпадению токенов, учитываются весовые коэффициенты: название > теги > описание. <br> 5. Ранжируются результаты по релевантности и дополнительным признакам: популярность видео, дата публикации, лайки/просмотры. <br> 6. Возвращается список отсортированных на фронтенд для отображения пользователю. |

## 8. Технологии

| Технология              | Область применения          | Мотивационная часть                                                                                                                                                                   |
| ----------------------- | --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **TypeScript**          | Frontend                    | Гарантирует строгую типизацию и уменьшает количество ошибок при разработке сложного интерфейса рекомендаций и комментариев.                                                           |
| **React**               | Frontend                    | Компонентный подход и быстрая отрисовка интерфейса при динамическом обновлении ленты видео.                                                                                           |
| **Golang**              | Backend                     | Высокая производительность и лёгкая масштабируемость делают его оптимальным для микросервисов (видео, рекомендации, аналитика).                                                       |
| **Python**              | Backend (ML-сервисы)        | Используется для генерации векторов пользователей и видео, обучения моделей и расчёта рекомендаций.                                                                                   |
| **Kotlin**              | Мобильное приложение        | Язык, который позволит создать мобильное приложение под Android.                                                                                                                      |
| **Swift**               | Мобильное приложение        | Язык, который позволит создать мобильное приложение под iOS                                                                                                                           |
| **PostgreSQL**          | Основная СУБД               | Основное хранилище структурированных данных (пользователи, видео, комментарии). Поддерживает pgvector для работы с эмбеддингами.                                                      |
| **ClickHouse**          | Аналитика и просмотры       | Подходит для хранения и анализа больших объёмов данных по просмотрам, реакциям и статистике взаимодействий.                                                                           |
| **Elasticsearch**       | Поиск по видео              | Быстрый полнотекстовый поиск по заголовкам, описаниям и авторам, учитывающий морфологию и популярность.                                                                               |
| **Redis**               | Кэш и сессии                | Используется для кэширования часто запрашиваемых данных и хранения токенов сессий, разгружая основную БД.                                                                             |
| **S3 (MinIO)**          | Хранение медиа              | Масштабируемое хранилище для видео, превью и аватаров с поддержкой репликации и edge-кэширования.                                                                                     |
| **Cloudflare**          | CDN                         | Распределённая доставка видео пользователю с минимальной задержкой, интегрируется с S3/MinIO.                                                                                         |
| **pgvector**            | Расширение PostgreSQL       | Позволяет хранить и сравнивать вектора пользователей и видео для расчёта косинусного сходства в рекомендациях.                                                                        |
| **Apache Kafka**        | Потоковая обработка событий | Используется для сбора и доставки событий (просмотры, лайки, комментарии) в реальном времени в сервисы аналитики и обновления рекомендаций. Позволяет строить реактивную архитектуру. |
| **MPEG-DASH**           | Потоковая передача видео    | Адаптивность качества потока, поддержка различных кодеков, масштабируемость.                                                                                                          |
| **Prometheus**          | Хранение метрик             | Сбор и хранение метрик производительности микросервисов для анализа и масштабирования.                                                                                                |
| **Grafana**             | Визуализация метрик         | Отображает состояние системы и эффективность выдачи рекомендаций в виде интерактивных дашбордов.                                                                                      |
| **Nginx**               | Reverse proxy / CDN edge    | Обеспечивает балансировку трафика, кэширование чанков видео и маршрутизацию запросов между сервисами.                                                                                 |
| **PgBouncer**           | Пул соединений PostgreSQL   | Уменьшает нагрузку на основную БД при большом числе одновременных подключений.                                                                                                        |
| **Kubernetes**          | Оркестрация и развертывание | Автоматизирует масштабирование микросервисов и обеспечивает отказоустойчивость при высоких нагрузках.                                                                                 |
| **Git + GitHub/GitLab** | Контроль версий и CI/CD     | Поддерживает совместную разработку, автоматическое тестирование и деплой.                                                                                                             |
| **Hugging Face Transformers**| Обработка текста (title, description)| Предоставляет готовые предобученные модели для извлечения смысловых признаков из заголовков и описаний видео, что делает векторы более информативными даже без тегов и категорий.|

## 9. Обеспечение надёжности

| Компонент                             | Механизмы надёжности и резервирования                                | Описание / мотивация                                                                                                                                                                                                           |
| ------------------------------------- | -------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Kubernetes / микросервисы**         | Репликация pod’ов, Auto-healing, Rolling updates                     | Kubernetes автоматически перезапускает контейнеры при сбое, перераспределяет нагрузку между узлами и обновляет сервисы без простоя. Это гарантирует стабильную работу API, видео- и ML-сервисов при обновлениях или сбоях.     |
| **Backend API (Golang)**              | N+1 балансировка, health-check через L7 LB, autoscaling              | Каждый микросервис (video, user, recommendation) разворачивается с избыточностью. Балансировщик направляет трафик только на здоровые инстансы, autoscaler масштабирует поды при росте нагрузки.                                |
| **Frontend (React / TypeScript)**     | CDN-кэширование, статическая репликация, version rollback            | Статика хранится на CDN и дублируется в нескольких зонах. В случае неудачного деплоя система откатывает предыдущую версию без влияния на пользователей.                                                                        |
| **DNS (GeoDNS)**                      | Дублирование NS-записей, TTL failover                                | Несколько независимых NS-серверов обеспечивают работу DNS при отказе одного. TTL настроен минимально для быстрого переключения на резервные адреса.                                                                            |
| **Anycast маршрутизация**             | BGP-анонс из нескольких ДЦ, автоматический reroute                   | Если один датацентр становится недоступен, трафик автоматически направляется по ближайшему маршруту без изменения IP для клиента.                                                                                              |
| **GNS / GSLB (Global Name Service)**  | Метрики состояния ДЦ, динамическое перенаправление трафика           | Трафик перераспределяется между регионами при перегрузке или деградации сервисов. GNS интегрируется с Prometheus и SDN-контроллером для автоматических решений.                                                                |
| **L3/L4 балансировщики**   | N+1 резервирование, keepalived                                       | Балансировщики работают по схеме Direct Routing. При сбое активного — назначается резервный. Производительность сохраняется, обратный трафик идёт напрямую.                                                                 |
| **L7 балансировщики (Nginx/HAProxy)** | N+1 резервирование, health-check, sticky sessions                    | L7 балансировщики имеют резервные копии. При недоступности узла запросы перенаправляются на резерв. Sticky sessions сохраняются.                                                                                               |
| **PostgreSQL** | Master–Slave репликация, full + incremental backup | Основные таблицы (user, video, comment и др.) реплицируются на несколько узлов. Репликация выполняется асинхронно или синхронно в зависимости от роли узлов. Резервные копии создаются ежедневно (full backup) и инкрементально каждые 6 часов (WAL archiving). Управление фейловером и ролями узлов осуществляется через Patroni. |
| **Patroni** | DCS (Distributed Configuration Store) + automatic failover | Обеспечивает автоматическое переключение PostgreSQL-кластера при сбое master-узла. Использует распределённое хранилище состояния (etcd / Consul / Zookeeper) для координации реплик. При отказе лидера назначает нового и синхронизирует кворум. |
| **ClickHouse**                        | Реплицированные таблицы (Zookeeper), шардирование                    | ClickHouse хранит аналитические данные с репликацией по узлам. При падении одного шарда запросы обслуживаются с реплики.                                                                                                       |
| **Elasticsearch**                     | Репликация индексов (replica shards)                                 | Каждый индекс хранится в нескольких репликах. При сбое одного узла данные автоматически восстанавливаются из реплики.                                                                                                          |
| **Redis**                             | Master–Replica с Sentinel, AOF-персистентность                       | Redis хранит сессии и кэш. Sentinel контролирует состояние узлов и выполняет failover при сбоях. AOF защищает от потери данных при аварийном завершении работы.                                                                |
| **S3 / MinIO**                        | Cross-region replication, versioning, Erasure Coding                 | Медиафайлы хранятся в нескольких регионах и версионируются. При потере узла данные восстанавливаются из соседнего региона без потерь.                                                                                          |
| **Kafka**                             | Репликация партиций, ISR (In-Sync Replicas)                          | Потоковые данные (просмотры, лайки, комментарии) сохраняются на нескольких брокерах. При падении одного брокера данные сохраняются на других.                                                                                  |
| **Prometheus + Grafana**              | HA-сетап, дублирование метрик, alerting                              | Метрики дублируются между узлами Prometheus, а алерты интегрированы с системами уведомлений. Потеря одного узла не влияет на наблюдаемость.                                                                                    |
| **PgBouncer / HAProxy**               | Пул соединений с failover, health-check                              | Поддерживают постоянную доступность соединений с БД, переключаясь при недоступности одного из backend’ов.                                                                                                                      |
| **CDN (Cloudflare)**                  | Edge replication, auto failover, regional caching                    | При сбое CDN-узла трафик автоматически направляется на ближайший живой узел. Контент реплицируется по регионам.                                                                                                                |
| **CI/CD (GitHub / GitLab)**           | Canary deploy, rollback, тестирование перед релизом                  | Автоматическая проверка и постепенное обновление сервисов. При ошибке релиза выполняется автоматический откат к предыдущей стабильной версии.                                                                                  |
| **Backup-система**                    | Ежедневные полные и инкрементальные копии, geo-redundant storage     | Все критичные данные (Postgres, ClickHouse, Elasticsearch) резервируются в нескольких регионах. Тест восстановления выполняется по расписанию.                                                                                 |

## 10. Схема проекта
<img width="1054" height="601" alt="structure" src="https://github.com/user-attachments/assets/4818527d-9c95-4d48-babf-072d6feffa4f" />


### Upload Service

1. Клиент отправляет запрос `POST /upload` с метаданными (`user_id`, `title`, `description`) и исходником видео.
2. **Upload Service** принимает данные, разбивает видео на чанки и временно сохраняет их в буферное хранилище.
3. После проверки целостности чанков Upload Service загружает их в **S3**.
4. После успешной загрузки создаётся событие `video_uploaded` → отправляется в **Kafka** (содержит `user_id`, `video_id`, `title`, `description`, `s3_urls[]`).

### Video Processing / ML Embedding Service

1. Слушает события `video_uploaded` из Kafka.
2. Загружает метаданные и при необходимости фрагменты из S3.
3. Генерирует эмбеддинги с помощью **Hugging Face Transformers** по `title` и `description`.
4. Полученные векторы сохраняются в таблицу **`video_vector`** в PostgreSQL (через pgvector).

### Recommendation Service

1. Подписан на события `video_index_ready`.
2. По событию обновляет таблицу **`user_vector`**, используя агрегированные предпочтения.
3. При запросе рекомендаций:
   * Проверяет кеш (Redis) по `user_id`.
   * Если данных нет, выполняет поиск ближайших векторов
   * Результаты кешируются (TTL).
4. Рекомендации фильтруются по активности, автору, приватности и т.д.


## Источники
1. [Пользователи и демография YouTube 2025](https://www.globalmediainsight.com/blog/youtube-users-statistics/#YouTube_Users_by_Country_2025)
2. [Аналитика трафика YouTube — SEMrush](https://www.semrush.com/seo/26309235)
3. [Статистика использования соцсетей — Shopify](https://www.shopify.com/blog/social-media-marketing-statistics)
4. [Ключевые метрики YouTube-каналов — Pixel Valley Studio](https://pixelvalleystudio.com/pmf-articles/4-key-youtube-channel-statistics-and-how-to-calculate-them)
5. [Три метрики успеха на YouTube — Tubular Labs](https://tubularlabs.com/blog/3-metrics-youtube-success/)
6. [Статистика продолжительности видео](https://www.statista.com/statistics/1026923/youtube-video-category-average-length/)
7. [Статистика количества видео по годам](https://seo.ai/blog/how-many-videos-are-on-youtube)
8. [Рекомендации по загружвемым видео](https://support.google.com/youtube/answer/1722171?hl=en)
9. [Информация по размерам видео](https://www.descript.com/blog/article/the-ultimate-guide-to-youtube-video-sizes)
10. [Размеры ревью к видео](https://support.google.com/youtube/answer/72431?hl=en&co=GENIE.Platform%3DAndroid#zippy=%2Cimage-size-resolution)
11. [Советы по превью](https://support.google.com/youtube/answer/12340300?hl=en)
12. [Информация о среднем количестве просмотров](https://tubularlabs.com/blog/average-youtube-views/)
13. [Информация о каналах](https://www.blogcadre.com/resources/how-many-youtube-channels-are-there/)
14. [Статистика DAU по годам](https://www.statista.com/statistics/1252638/youtube-app-dau-worldwide/)
